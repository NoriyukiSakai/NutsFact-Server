<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nines.nutsfact.infrastructure.mapper.RawMaterialAdditiveMapper">

    <resultMap id="RawMaterialAdditiveResultMap" type="com.nines.nutsfact.domain.model.additive.RawMaterialAdditive">
        <id property="id" column="id"/>
        <result property="businessAccountId" column="business_account_id"/>
        <result property="foodId" column="food_id"/>
        <result property="additiveId" column="additive_id"/>
        <result property="displayOrder" column="display_order"/>
        <result property="usageAmount" column="usage_amount"/>
        <result property="exemptionType" column="exemption_type"/>
        <result property="exemptionReason" column="exemption_reason"/>
        <result property="allergenOrigin" column="allergen_origin"/>
        <result property="isActive" column="is_active"/>
        <result property="createDate" column="create_date"/>
        <result property="updateDate" column="update_date"/>
    </resultMap>

    <resultMap id="RawMaterialAdditiveWithAdditiveResultMap" type="com.nines.nutsfact.domain.model.additive.RawMaterialAdditive">
        <id property="id" column="id"/>
        <result property="businessAccountId" column="business_account_id"/>
        <result property="foodId" column="food_id"/>
        <result property="additiveId" column="additive_id"/>
        <result property="displayOrder" column="display_order"/>
        <result property="usageAmount" column="usage_amount"/>
        <result property="exemptionType" column="exemption_type"/>
        <result property="exemptionReason" column="exemption_reason"/>
        <result property="allergenOrigin" column="allergen_origin"/>
        <result property="isActive" column="is_active"/>
        <result property="createDate" column="create_date"/>
        <result property="updateDate" column="update_date"/>
        <association property="additive" javaType="com.nines.nutsfact.domain.model.additive.Additive">
            <id property="additiveId" column="a_additive_id"/>
            <result property="businessAccountId" column="a_business_account_id"/>
            <result property="additiveCode" column="a_additive_code"/>
            <result property="substanceName" column="a_substance_name"/>
            <result property="simplifiedName" column="a_simplified_name"/>
            <result property="purposeCategory" column="a_purpose_category"/>
            <result property="collectiveName" column="a_collective_name"/>
            <result property="requiresPurposeDisplay" column="a_requires_purpose_display"/>
            <result property="description" column="a_description"/>
            <result property="isActive" column="a_is_active"/>
        </association>
    </resultMap>

    <select id="findByFoodId" resultMap="RawMaterialAdditiveResultMap">
        SELECT id, business_account_id, food_id, additive_id, display_order, usage_amount,
               exemption_type, exemption_reason, allergen_origin, is_active, create_date, update_date
        FROM food_raw_material_additive
        WHERE food_id = #{foodId}
          AND is_active = TRUE
        ORDER BY display_order, id
    </select>

    <select id="findByFoodIdWithAdditive" resultMap="RawMaterialAdditiveWithAdditiveResultMap">
        SELECT rma.id, rma.business_account_id, rma.food_id, rma.additive_id, rma.display_order,
               rma.usage_amount, rma.exemption_type, rma.exemption_reason, rma.allergen_origin,
               rma.is_active, rma.create_date, rma.update_date,
               a.additive_id as a_additive_id, a.business_account_id as a_business_account_id,
               a.additive_code as a_additive_code, a.substance_name as a_substance_name,
               a.simplified_name as a_simplified_name, a.purpose_category as a_purpose_category,
               a.collective_name as a_collective_name, a.requires_purpose_display as a_requires_purpose_display,
               a.description as a_description, a.is_active as a_is_active
        FROM food_raw_material_additive rma
        LEFT JOIN master_additive a ON rma.additive_id = a.additive_id
        WHERE rma.food_id = #{foodId}
          AND rma.is_active = TRUE
        ORDER BY rma.display_order, rma.id
    </select>

    <select id="findByBusinessAccountId" resultMap="RawMaterialAdditiveResultMap">
        SELECT id, business_account_id, food_id, additive_id, display_order, usage_amount,
               exemption_type, exemption_reason, allergen_origin, is_active, create_date, update_date
        FROM food_raw_material_additive
        WHERE business_account_id = #{businessAccountId}
          AND is_active = TRUE
        ORDER BY food_id, display_order
    </select>

    <select id="findById" resultMap="RawMaterialAdditiveResultMap">
        SELECT id, business_account_id, food_id, additive_id, display_order, usage_amount,
               exemption_type, exemption_reason, allergen_origin, is_active, create_date, update_date
        FROM food_raw_material_additive
        WHERE id = #{id}
    </select>

    <select id="findByIdAndBusinessAccountId" resultMap="RawMaterialAdditiveResultMap">
        SELECT id, business_account_id, food_id, additive_id, display_order, usage_amount,
               exemption_type, exemption_reason, allergen_origin, is_active, create_date, update_date
        FROM food_raw_material_additive
        WHERE id = #{id}
        <if test="businessAccountId != null">
            AND business_account_id = #{businessAccountId}
        </if>
    </select>

    <insert id="insert" parameterType="com.nines.nutsfact.domain.model.additive.RawMaterialAdditive" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO food_raw_material_additive (business_account_id, food_id, additive_id, display_order,
                                                usage_amount, exemption_type, exemption_reason, allergen_origin, is_active)
        VALUES (#{businessAccountId}, #{foodId}, #{additiveId}, #{displayOrder},
                #{usageAmount}, #{exemptionType}, #{exemptionReason}, #{allergenOrigin}, #{isActive})
    </insert>

    <update id="update" parameterType="com.nines.nutsfact.domain.model.additive.RawMaterialAdditive">
        UPDATE food_raw_material_additive
        SET additive_id = #{additiveId},
            display_order = #{displayOrder},
            usage_amount = #{usageAmount},
            exemption_type = #{exemptionType},
            exemption_reason = #{exemptionReason},
            allergen_origin = #{allergenOrigin},
            is_active = #{isActive}
        WHERE id = #{id}
        <if test="businessAccountId != null">
            AND business_account_id = #{businessAccountId}
        </if>
    </update>

    <delete id="delete">
        DELETE FROM food_raw_material_additive WHERE id = #{id}
    </delete>

    <delete id="deleteByIdAndBusinessAccountId">
        DELETE FROM food_raw_material_additive
        WHERE id = #{id}
        <if test="businessAccountId != null">
            AND business_account_id = #{businessAccountId}
        </if>
    </delete>

    <delete id="deleteByFoodId">
        DELETE FROM food_raw_material_additive WHERE food_id = #{foodId}
    </delete>

</mapper>
